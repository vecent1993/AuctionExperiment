<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- jQuery -->
    <script type="text/javascript" language="javascript" src="/static/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" language="javascript" src="/static/js/jquery-ui.js"></script>
    <!-- Bootstrap -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- self -->
	<title>Dashboard</title>
<style type="text/css">

</style>
</head>
<body>

{% include 'nav.html' %}

	<div class="container-fluid" style="">
		<div class="row">

            <div class="col-md-8 col-md-offset-2" id="main">

            {% module xsrf_form_html() %}

            </div>

        </div>
	</div>

<script type="text/javascript" language="javascript">

function getCookie(name) {
    var r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
    return r ? r[1] : undefined;
};

$.post = function(url, args, callback) {
    args._xsrf = getCookie("_xsrf");
    $.ajax({url: url, data: $.param(args), dataType: "text", type: "POST",
        success: function(response) {
        callback(response);
    }});
};

var ws = new WebSocket("ws://{{ request.host }}/exp/{{ exp['exp_id'] }}/websocket/official");

var send = function (data, callback) {
    waitForConnection(function () {
        ws.send( JSON.stringify(data) );
        if (typeof callback !== 'undefined') {
            callback();
        }
    }, 5);
};

var waitForConnection = function (callback, interval) {
    if (ws.readyState === 1) {
        callback();
    } else {
        // optional: implement backoff for interval here
        setTimeout(function () {
            waitForConnection(callback, interval);
        }, interval);
    }
};

function msgHandler(ws){
    var that = this;
    ws.onmessage = function (evt) {
        msg = JSON.parse(evt.data);
        if( that[msg.cmd] ){
            that[msg.cmd](msg.data, evt);
        }
    };
};

ws.handler = new msgHandler(ws)


$(document).ready(function(){

    ws.handler.replace = function(data, evt){
         $("#main").html(msg.data);
    };

    ws.handler.wait = function(data, evt){
         $(".waiting").show();
    };

    ws.handler.redirect = function(data, evt){
        document.location.href = data;
    };

    send( {cmd: 'get'} );

    var heartbeat = setInterval(send, 30000, {'cmd': 'heartbeat'});

});

</script>

</body>
</html>