<!DOCTYPE html>
<html>
<head lang="en">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- jQuery -->
    <script type="text/javascript" language="javascript" src="/static/js/jquery-1.11.1.min.js"></script>
    <!-- Bootstrap -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- self -->
	<title>用户注册</title>
</head>
<body>

    {% include '../nav.html' %}

    <div class="container-fluid">
		<div class="row">
            <form method="post" class='col-md-4 col-md-offset-4 form-horizontal' action="/account/register">
                {% module xsrf_form_html() %}
                <div class="form-group">
			        <label class="col-md-2 control-label">邮箱</label>
                    <div class="col-md-8">
                          <input type="email" class="form-control" name="email" placeholder="邮箱" required>
                    </div>
			    </div>
                <div class="form-group">
			        <label class="col-md-2 control-label">用户名</label>
                    <div class="col-md-8">
			            <input type="text" class="form-control" name="username" placeholder="用户名" required
                            pattern="^[A-Za-z0-9]{6,22}$" oninvalid="setCustomValidity('用户名必须6位以上大小写英文或者数字组成');" oninput="setCustomValidity('');">
			        </div>
                </div>
			    <div class="form-group">
			        <label class="col-md-2 control-label">密码</label>
                    <div class="col-md-8">
			            <input type="password" class="form-control" name="password" placeholder="密码" required
                            pattern="^[\@A-Za-z0-9\!\#\$\%\^\&\*\.\~]{6,22}$" oninvalid="setCustomValidity('密码必须6-22位字符');" oninput="setCustomValidity('');">
			        </div>
                </div>
                <div class="form-group">
			        <label class="col-md-2 control-label">重复密码</label>
                    <div class="col-md-8">
			            <input type="password" class="form-control" name="re-password" placeholder="密码" required
                            oninvalid="setCustomValidity('密码必须一致');" oninput="setCustomValidity('');">
			        </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label">性别</label>
                    <div class="col-md-8">
                        <label class="radio-inline">
                            <input type="radio" name="gender" value="0" checked> 男
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="gender" value="1"> 女
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label">年龄</label>
                    <div class="col-md-8">
                        <input type="number" class="form-control" name="age" placeholder="年龄" min="10"
                               max="120" step="1"required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-2 control-label">国籍</label>
                    <div class="col-md-8">
                        <select class="form-control" name="nation" required>
                            {% for nation in nations %}
                            <option value ="{{ nation['nation_id'] }}" {%if nation['nation_id'] == 37 %}selected{% end %}>{{ nation['nation_name'] }}</option>
                            {% end %}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label">来源</label>
                    <div class="col-md-8">
                        <label class="radio-inline">
                            <input type="radio" name="residence" value="0" checked> 城市
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="residence" value="1"> 农村
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-2 control-label">身份</label>
                    <div class="col-md-8">
                        <label class="radio-inline">
                            <input type="radio" name="identity" value="0" checked> 学生
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="identity" value="1"> 老师
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="identity" value="2"> 其他
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label">专业</label>
                    <div class="col-md-8">
                        <select class="form-control" name="major">
                            {% for major in majors %}
                            <option value ="{{ major['major_code'] }}" {%if major['major_code'] == '0811' %}selected{% end %}>{{ major['major_name'] }}</option>
                            {% end %}
                        </select>
                    </div>
                </div>

			    <div class="form-group">
                    <div class="col-md-offset-2">
			  	        <button type="submit" class="btn btn-primary">注册</button>
                        <label>已有账号？马上<a href="/account/login">登录</a></label>
                    </div>
			    </div>
			</form>
		</div>
	</div>

<script>
function getCookie(name) {
    var r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
    return r ? r[1] : undefined;
};

$.post = function(url, args, callback) {
    args._xsrf = getCookie("_xsrf");
    $.ajax({url: url, data: $.param(args), dataType: "json", type: "POST",
        success: function(response) {
            callback(response);
        }
    });
};

function formData(selector){
    var args = $(selector).serializeArray();
    var data = {};
    for(var i=0; i < args.length; i++){
        data[args[i].name] = args[i].value;
    }
    return data;
};

function checkPwd(){
    var pwd = $("input[name='password']").val();
    var repwd = $("input[name='re-password']").val();
    if(pwd != repwd){
        var field = document.getElementsByName('re-password')[0];
        field.setCustomValidity('密码必须一致');
        field.reportValidity();
        return false;
    }
    return true;
}

$(document).ready(function(){
    $("form").submit(function(event){
        event.preventDefault();
        if(checkPwd()){
            $("form button[type='submit']").attr("disabled", "disabled");
            $("form button[type='submit']").html("正在注册");
            $.post("", formData("form"), function(res){
                $("form button[type='submit']").removeAttr("disable");
                $("form button[type='submit']").html("注册");
                if(res.errors){
                    for(var i=0; i < res.errors.length; i++){
                        var field = document.getElementsByName(res.errors[i].name)[0];
                        field.setCustomValidity(res.errors[i].reason);
                        field.reportValidity();
                    }
                }
                else{
                    document.location.href = res.redirect;
                }
            });
        }
    });
});
</script>

</body>
</html>