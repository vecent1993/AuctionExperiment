<!DOCTYPE html>
<html>
<head lang="en">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <script type="text/javascript" language="javascript" src="/static/js/jquery-1.11.1.min.js"></script>

    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/js/bootstrap.min.js"></script>

    <title>{% if train %}训练{% else %}正式试验{% end %}-{{ exp['exp_title'] }}</title>
    <style>

        .timer span.countdown {
            font-family: Helvetica, Microsoft YaHei, Arial, sans-serif;
            font-size: 20px;
            color: #151515;
            font-weight: bold;
        }

        .toolbar {
            font-size: 20px;
            float: right;
            margin-right: 100px;
        }

        .toolbar a {
            margin-right: 10px;
        }

    </style>
</head>
<body>

{% include 'nav.html' %}

<div class="container-fluid">
    <div class="row">

        <div class="toolbar">
            <a href="javascript:void(0)" title="聊天室">
                <span class="glyphicon glyphicon-comment" aria-hidden="true"></span>
            </a>
            <a href="/help/exp" target="_blank" title="FQA">
                <span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
            </a>
            <a href="javascript:void(0)" class="show-introduction" title="实验操作说明">
                <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
            </a>
            <a href="/exp/{{ exp['exp_id'] }}" title="返回实验首页">
                <span class="glyphicon glyphicon-link" aria-hidden="true"></span>
            </a>
        </div>

        <div class="col-md-10 col-md-offset-1" id="main">

        {% module xsrf_form_html() %}

        </div>

        <div class="modal fade introduction" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="exampleModalLabel">操作说明</h4>
                    </div>
                    <div class="modal-body">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="text/javascript" language="javascript">

function getCookie(name) {
    var r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
    return r ? r[1] : undefined;
};

$.post = function(url, args, callback) {
    args._xsrf = getCookie("_xsrf");
    $.ajax({url: url, data: $.param(args), dataType: "text", type: "POST",
        success: function(response) {
            callback(response);
        }
    });
};

function Timer(seconds, id, func){
    this.seconds = seconds;
    this.elementId = id;
    this.func = func;
    this.start = function(){
        that.countDown();
        that.timer = setInterval(that.countDown, 1000);
    };
    this.timeout = function(){
        if(that.func)
            that.func();
    };
    var that = this;
    this.countDown = function(){
        $("#"+that.elementId+" span.countdown").html(that.seconds);
        if(that.seconds == 0){
            that.stop();
            that.timeout();
        } else {
            that.seconds--;
        }
    }
    this.stop = function(){
        clearInterval(that.timer);
    };
    this.set = function(seconds){
        that.stop();
        that.seconds = seconds;
        that.start();
    };
    this.hide = function(){
        $("#"+that.elementId).hide();
    };
    this.show = function(){
        $("#"+that.elementId).show();
    }
}


var ws = new WebSocket("ws://{{ request.host }}/exp/{{ exp['exp_id'] }}/websocket/{% if train %}train{% else %}official{% end %}");

var send = function (data, callback) {
    waitForConnection(function () {
        ws.send( JSON.stringify(data) );
        if (typeof callback !== 'undefined') {
            callback();
        }
    }, 5);
};

var waitForConnection = function (callback, interval) {
    if (ws.readyState === 1) {
        callback();
    } else {
    // optional: implement backoff for interval here
        setTimeout(function () {
            waitForConnection(callback, interval);
        }, interval);
    }
};

function msgHandler(ws){
    var that = this;
    ws.onmessage = function (evt) {
        msg = JSON.parse(evt.data);
        if( that[msg.cmd] ){
            that[msg.cmd](msg.data, evt);
        }
    };
};

ws.handler = new msgHandler(ws)

$(document).ready(function(){

    $("a.show-introduction").on("click", function(){
        $(".modal.introduction").modal('toggle');
    });

    ws.handler.replace = function(data, evt){
        $("#main").html(data);
    };

    ws.handler.refresh = function(data, evt) {
        send( {cmd: 'get'} );
    };

    ws.handler.redirect = function(data, evt){
        document.location.href = data;
    };

    ws.handler.error = function(data, evt){
        console.log(data);
    }

    send( {cmd: 'get'} );

    var heartbeat = setInterval(send, 30000, {'cmd': 'heartbeat'});
});

</script>

</body>
</html>